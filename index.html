<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plano de Corte Inteligente - Fama Helicoidal</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

        :root {
            --font-family: 'Inter', sans-serif;
            --transition-fast: 0.2s ease;
        }

        /* THEME SETUP */
        body { font-family: var(--font-family); display: flex; margin: 0; transition: background-color var(--transition-fast), color var(--transition-fast); }
        body[data-theme="light"] {
            --bg: #F8F9FA; --sidebar-bg: #FFFFFF; --card-bg: #FFFFFF; --text-primary: #181C32; --text-secondary: #7E8299; --border: #E4E6EF;
            --red: #E51937; --red-dark: #D90429; --green: #00B297; --green-dark: #00917A; --yellow: #FFC700; --blue: #00A3FF;
            --shadow: 0px 4px 12px rgba(0, 0, 0, 0.05); --red-rgb: 229, 25, 55; --green-rgb: 0, 178, 151;
        }
        body[data-theme="dark"] {
            --bg: #151521; --sidebar-bg: #1E1E2D; --card-bg: #1E1E2D; --text-primary: #FFFFFF; --text-secondary: #A1A5B7; --border: #2d2d43;
            --red: #F1416C; --red-dark: #E12954; --green: #50CD89; --green-dark: #3DBA74; --yellow: #FFC700; --blue: #00A3FF;
            --shadow: 0px 4px 12px rgba(0, 0, 0, 0.1); --red-rgb: 241, 65, 108; --green-rgb: 80, 205, 137;
        }

        /* LAYOUT & GENERAL */
        .sidebar { width: 265px; height: 100vh; background-color: var(--sidebar-bg); display: flex; flex-direction: column; padding: 2rem 1.5rem; box-sizing: border-box; position: fixed; left: 0; top: 0; transition: background-color var(--transition-fast); border-right: 1px solid var(--border); }
        .main-content { flex-grow: 1; margin-left: 265px; padding: 2rem 3rem; background-image: linear-gradient(var(--border) 1px, transparent 1px), linear-gradient(90deg, var(--border) 1px, transparent 1px); background-size: 25px 25px; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .page-header { text-align: center; margin-bottom: 3rem; }
        .page-title { font-size: 2rem; font-weight: 800; color: var(--text-primary); margin: 0; }
        .page-subtitle { font-size: 1rem; color: var(--text-secondary); margin-top: 0.5rem; font-weight: 500; }
        .card { background-color: var(--card-bg); border-radius: 12px; box-shadow: var(--shadow); transition: background-color var(--transition-fast), box-shadow var(--transition-fast); }
        .btn { border: none; padding: 14px 28px; border-radius: 8px; font-weight: 700; font-size: 1rem; cursor: pointer; transition: all var(--transition-fast); display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .btn:disabled { background-color: var(--text-secondary); cursor: not-allowed; opacity: 0.7; }
        .btn-primary { background-color: var(--red); color: white; }
        .btn-primary:hover:not(:disabled) { background-color: var(--red-dark); }
        .btn-secondary { background-color: var(--green); color: white; }
        .btn-secondary:hover:not(:disabled) { background-color: var(--green-dark); }
        .btn-tertiary { background: transparent; border: 2px solid var(--border); color: var(--text-secondary); }
        .btn-tertiary:hover { border-color: var(--text-secondary); background-color: var(--border); }
        .btn-sm { padding: 10px 20px; font-size: 0.9rem; }
        .spinner { border: 2px solid rgba(255,255,255,0.3); border-top: 2px solid #fff; border-radius: 50%; width: 18px; height: 18px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* SIDEBAR STYLES */
        .sidebar-header { text-align: center; margin-bottom: 2.5rem; }
        .sidebar-header .logo-light { display: block; } .sidebar-header .logo-dark { display: none; }
        body[data-theme="dark"] .sidebar-header .logo-light { display: none; }
        body[data-theme="dark"] .sidebar-header .logo-dark { display: block; }
        .sidebar-header img { height: 40px; margin: 0 auto; }
        .sidebar-title { margin: 1rem 0 0.5rem; font-size: 1.1rem; font-weight: 700; color: var(--text-primary); }
        .sidebar-subtitle { display: inline-block; background-color: var(--border); color: var(--text-secondary); font-size: 0.7rem; font-weight: 600; padding: 4px 8px; border-radius: 4px; }
        .nav-menu { flex-grow: 1; }
        .nav-item { display: flex; align-items: center; padding: 12px 16px; border-radius: 8px; margin-bottom: 0.5rem; cursor: pointer; color: var(--text-secondary); font-weight: 600; transition: all var(--transition-fast); }
        .nav-item:hover { background-color: rgba(var(--red-rgb), 0.1); color: var(--red); }
        .nav-item.active { background-color: var(--red); color: white; }
        .mode-switcher { display: flex; align-items: center; justify-content: center; padding: 12px; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; font-weight: 600; color: var(--text-secondary); transition: all var(--transition-fast); }
        .mode-switcher:hover { border-color: var(--text-secondary); }

        /* --- PÁGINA INÍCIO --- */
        #page-inicio .upload-card { padding: 3rem; display: flex; align-items: center; gap: 3rem; }
        #page-inicio .upload-area { flex-grow: 1; text-align: center; border: 2px dashed var(--border); border-radius: 12px; padding: 3rem; cursor: pointer; transition: all var(--transition-fast); }
        #page-inicio .upload-area:hover { border-color: var(--red); background-color: var(--bg); }
        #page-inicio .upload-icon { width: 64px; height: 64px; line-height: 64px; background-color: var(--bg); border-radius: 12px; margin: 0 auto 1rem; color: var(--text-secondary); display: flex; align-items: center; justify-content: center; }
        #page-inicio .upload-title { font-size: 1.25rem; font-weight: 700; }
        #page-inicio #file-name-display { color: var(--green); font-weight: 600; margin-top: 1rem; min-height: 24px; }
        #page-inicio .actions-area { width: 300px; text-align: center; }
        #page-inicio .actions-title { font-weight: 700; font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 1rem; }
        #page-inicio .actions-info { font-weight: 600; font-size: 0.9rem; margin-bottom: 1.5rem; }
        #page-inicio .btn { width: 100%; }
        #page-inicio .kpi-cards { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2rem; margin-bottom: 2rem; }
        #page-inicio .kpi-card { padding: 2rem; text-align: center; }
        #page-inicio .kpi-value { font-size: 2.5rem; font-weight: 800; }
        #page-inicio .kpi-label { font-size: 1rem; font-weight: 600; color: var(--text-secondary); }
        #page-inicio .session-actions { display: flex; align-items: center; justify-content: flex-end; gap: 1rem; padding: 0 1rem 1rem 0; font-size: 0.9rem; font-weight: 600; }
        #page-inicio .main-cta { text-align: center; }
        #page-inicio .main-cta .btn { padding: 1.25rem 3rem; font-size: 1.25rem; border-radius: 50px; }

        /* --- PÁGINA DEMANDA --- */
        .filter-bar { background-color: var(--card-bg); padding: 1rem 1.5rem; border-radius: 12px; display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem; }
        .search-input { flex-grow: 1; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 12px 16px; font-size: 1rem; color: var(--text-primary); }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td { padding: 1rem 1.5rem; text-align: left; }
        .data-table th { color: var(--text-secondary); font-size: 0.8rem; font-weight: 600; text-transform: uppercase; border-bottom: 1px solid var(--border); }
        .data-table td { font-weight: 600; border-bottom: 1px solid var(--border); }
        .data-table tr:last-child td { border-bottom: none; }
        
        /* --- PLACEHOLDER FOR OTHER PAGES --- */
        .placeholder-content { padding: 4rem; text-align: center; color: var(--text-secondary); }
    </style>
</head>
<body data-theme="dark">

    <aside class="sidebar">
        <div class="sidebar-header">
             <img class="logo-light" src="https://www.molasfama.com.br/images/logo.png" alt="Fama Logo Light">
            <img class="logo-dark" src="https://ctfamadobrasil.com.br/wp-content/uploads/2025/12/Gemini_Generated_Image_v8cib8v8cib8v8ci-removebg-preview.png" alt="Fama Logo Dark">
            <h1 class="sidebar-title">PLANO DE CORTE INTELIGENTE</h1>
            <span class="sidebar-subtitle">LINHA HELICOIDAL</span>
        </div>
        <nav class="nav-menu">
            <div class="nav-item active" data-target="page-inicio">Início</div>
            <div class="nav-item" data-target="page-demanda">Demanda</div>
            <div class="nav-item" data-target="page-otimizador">Otimizador</div>
            <div class="nav-item" data-target="page-historico">Histórico</div>
        </nav>
        <div class="mode-switcher"><span class="mode-text">Modo Dia</span></div>
    </aside>

    <main class="main-content">
        <!-- CORREÇÃO: Adicionada a classe 'active' para que a tela de início seja visível por padrão -->
        <section id="page-inicio" class="page active">
            <div id="initial-state" style="display: none;">
                <div class="page-header">
                    <h2 class="page-title">CONTROLE DE SESSÃO</h2>
                    <p class="page-subtitle">IMPORTAÇÃO DA PLANILHA DE DEMANDA DE ESTOQUE</p>
                </div>
                <div class="card upload-card">
                    <label for="csv-input" class="upload-area">
                        <div class="upload-icon"><!-- SVG ICON --></div>
                        <h3 class="upload-title">ANEXAR PLANILHA DE DEMANDA</h3>
                        <p class="text-secondary" id="file-name-display">Nenhum arquivo selecionado</p>
                    </label>
                    <input type="file" id="csv-input" accept=".csv" style="display: none;">
                    <div class="actions-area">
                        <h4 class="actions-title">PLANILHA DE ESTOQUE</h4>
                        <p class="actions-info">Certifique-se que o arquivo contém as colunas chave.</p>
                        <button class="btn btn-primary" id="start-session-btn" disabled>
                            <span class="btn-text">INICIAR SESSÃO</span>
                            <div class="spinner" style="display: none;"></div>
                        </button>
                    </div>
                </div>
            </div>
            <div id="session-dashboard" style="display: none;">
                <div class="page-header">
                    <h2 class="page-title">SESSÃO EM ANDAMENTO</h2>
                    <p class="page-subtitle" id="sync-info"></p>
                </div>
                <div class="session-actions">
                    <button class="btn btn-tertiary btn-sm" id="end-session-btn">FINALIZAR SESSÃO</button>
                </div>
                <div class="kpi-cards">
                    <div class="card kpi-card"><div class="kpi-value" id="kpi-skus">0</div><div class="kpi-label">SKUS PROCESSADOS</div></div>
                    <div class="card kpi-card"><div class="kpi-value" id="kpi-bitolas">0</div><div class="kpi-label">BITOLAS ATIVAS</div></div>
                    <div class="card kpi-card"><div class="kpi-value" id="kpi-pecas">0</div><div class="kpi-label">TOTAL PEÇAS ORDEM</div></div>
                </div>
                <div class="main-cta"><button class="btn btn-secondary" id="go-to-demand-btn">ACESSAR MATRIZ DE TRABALHO</button></div>
            </div>
        </section>

        <section id="page-demanda" class="page">
             <div class="page-header" style="text-align: left;"><h2 class="page-title">Matriz de Demanda</h2></div>
             <div class="filter-bar card">
                <input type="text" id="demand-search-input" class="search-input" placeholder="Buscar código da mola...">
            </div>
            <div class="card">
                <table class="data-table">
                    <thead><tr><th>PRODUTO</th><th>QTDE. A PRODUZIR</th><th>BITOLA (FINAL)</th><th>COMP. (MM)</th></tr></thead>
                    <tbody id="demand-table-body"></tbody>
                </table>
            </div>
        </section>
        
        <section id="page-otimizador" class="page">
            <div class="page-header" style="text-align: left;"><h2 class="page-title">Otimizador de Corte</h2></div>
            <div class="card placeholder-content">
                <h3>Funcionalidade em Desenvolvimento</h3>
                <p>A interface para o otimizador será construída aqui.</p>
            </div>
        </section>

        <section id="page-historico" class="page">
            <div class="page-header" style="text-align: left;"><h2 class="page-title">Histórico de Otimizações</h2></div>
             <div class="card placeholder-content">
                <h3>Funcionalidade em Desenvolvimento</h3>
                <p>A interface para o histórico de otimizações será construída aqui.</p>
            </div>
        </section>

    </main>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- CONFIGURAÇÕES E ESTADO GLOBAL ---
        const SUPABASE_URL = 'https://mqzrlzywqgylffwvtlmg.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1xenJsenl3cWd5bGZmd3Z0bG1nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxNzExNDcsImV4cCI6MjA3NTc0NzE0N30.YghplsFD3T1Xv0yuLYTdD9Ib5kenXitDMnXAud7TjSY';
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const N8N_START_SESSION_URL = 'https://n8n-n8n.znxk1t.easypanel.host/webhook/iniciar-sessao-helicoidais';
        const N8N_END_SESSION_URL = 'https://n8n-n8n.znxk1t.easypanel.host/webhook/finalizar-sessao-helicoidais';
        const SESSION_TABLE = 'produtos_sessao_helicoidal';
        
        let state = { selectedFile: null, sessionProducts: [] };

        // --- SELETORES DE UI ---
        const ui = {
            body: document.body,
            navItems: document.querySelectorAll('.nav-item'),
            pages: document.querySelectorAll('.page'),
            modeSwitcher: document.querySelector('.mode-switcher'),
            modeText: document.querySelector('.mode-text'),
            csvInput: document.getElementById('csv-input'),
            fileNameDisplay: document.getElementById('file-name-display'),
            startSessionBtn: document.getElementById('start-session-btn'),
            endSessionBtn: document.getElementById('end-session-btn'),
            goToDemandBtn: document.getElementById('go-to-demand-btn'),
            initialStateView: document.getElementById('initial-state'),
            sessionDashboardView: document.getElementById('session-dashboard'),
            demandTableBody: document.getElementById('demand-table-body'),
            demandSearchInput: document.getElementById('demand-search-input'),
            kpiSkus: document.getElementById('kpi-skus'),
            kpiBitolas: document.getElementById('kpi-bitolas'),
            kpiPecas: document.getElementById('kpi-pecas'),
            syncInfo: document.getElementById('sync-info')
        };

        // --- FUNÇÕES DE RENDERIZAÇÃO ---
        const render = {
            loader: (button, show) => {
                const text = button.querySelector('.btn-text');
                const spinner = button.querySelector('.spinner');
                button.disabled = show;
                if (text && spinner) {
                    text.style.display = show ? 'none' : 'inline-block';
                    spinner.style.display = show ? 'inline-block' : 'none';
                }
            },
            switchPage: (targetId) => {
                ui.navItems.forEach(nav => nav.classList.remove('active'));
                const activeNavItem = document.querySelector(`.nav-item[data-target="${targetId}"]`);
                if(activeNavItem) activeNavItem.classList.add('active');
                
                ui.pages.forEach(page => page.classList.toggle('active', page.id === targetId));
            },
            updateSessionView: (isActive, products = []) => {
                if (isActive) {
                    ui.initialStateView.style.display = 'none';
                    ui.sessionDashboardView.style.display = 'block';
                    
                    const totalSkus = products.length;
                    const uniqueBitolas = [...new Set(products.map(p => p.bitola_final).filter(Boolean))].length;
                    const totalPecas = products.reduce((sum, p) => sum + (p.qtde_a_produzir || 0), 0);

                    ui.kpiSkus.textContent = totalSkus;
                    ui.kpiBitolas.textContent = uniqueBitolas;
                    ui.kpiPecas.textContent = totalPecas.toLocaleString('pt-BR');
                    ui.syncInfo.textContent = `SINCRONIZADO: ${new Date().toLocaleTimeString('pt-BR')} • OP ATIVA`;

                    render.demandaTable(products);
                } else {
                    ui.initialStateView.style.display = 'block';
                    ui.sessionDashboardView.style.display = 'none';
                    state.sessionProducts = [];
                    render.demandaTable([]);
                }
            },
            demandaTable: (products) => {
                ui.demandTableBody.innerHTML = products.map(p => `
                    <tr>
                        <td>${p.codigo || 'N/A'}</td>
                        <td>${p.qtde_a_produzir || 0}</td>
                        <td style="color: var(--blue);">${p.bitola_final || 'Pendente'}</td>
                        <td>${p.comprimento_barra_mm || 'Pendente'}</td>
                    </tr>
                `).join('');
            }
        };
        
        // --- LÓGICA DE API E DADOS ---
        const api = {
            startSession: (file) => {
                if (!file) return;
                render.loader(ui.startSessionBtn, true);
                
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: async (results) => {
                        try {
                            const response = await fetch(N8N_START_SESSION_URL, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ products: results.data }),
                            });
                            if (!response.ok) throw new Error('Falha ao iniciar sessão no servidor.');
                            
                            const products = await api.fetchSessionProducts();
                            state.sessionProducts = products;
                            render.updateSessionView(true, products);
                            render.switchPage('page-demanda');
                            
                        } catch (error) {
                            console.error(error);
                            alert('Erro ao iniciar sessão: ' + error.message);
                        } finally {
                            render.loader(ui.startSessionBtn, false);
                        }
                    }
                });
            },
            endSession: async () => {
                if (!confirm('Deseja realmente finalizar a sessão atual?')) return;
                try {
                    await fetch(N8N_END_SESSION_URL, { method: 'POST' });
                    render.updateSessionView(false);
                    render.switchPage('page-inicio');
                } catch (error) {
                    alert('Erro ao finalizar a sessão.');
                }
            },
            fetchSessionProducts: async () => {
                const { data, error } = await supabase.from(SESSION_TABLE).select('*');
                if (error) {
                    console.error("Erro ao buscar produtos da sessão:", error);
                    return [];
                }
                return data;
            }
        };

        // --- FUNÇÃO PRINCIPAL DE VERIFICAÇÃO ---
        const checkActiveSession = async () => {
            const { count } = await supabase.from(SESSION_TABLE).select('*', { count: 'exact', head: true });
            if (count > 0) {
                const products = await api.fetchSessionProducts();
                state.sessionProducts = products;
                render.updateSessionView(true, products);
                render.switchPage('page-demanda');
            } else {
                render.updateSessionView(false);
                render.switchPage('page-inicio');
            }
        };

        // --- EVENT LISTENERS ---
        ui.navItems.forEach(item => {
            item.addEventListener('click', () => render.switchPage(item.dataset.target));
        });

        ui.modeSwitcher.addEventListener('click', () => {
            const currentTheme = ui.body.dataset.theme;
            ui.body.dataset.theme = (currentTheme === 'light') ? 'dark' : 'light';
            ui.modeText.textContent = (ui.body.dataset.theme === 'dark') ? 'Modo Dia' : 'Modo Noite';
        });

        ui.csvInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                state.selectedFile = file;
                ui.fileNameDisplay.textContent = file.name;
                ui.startSessionBtn.disabled = false;
            } else {
                state.selectedFile = null;
                ui.fileNameDisplay.textContent = 'Nenhum arquivo selecionado';
                ui.startSessionBtn.disabled = true;
            }
        });

        ui.startSessionBtn.addEventListener('click', () => api.startSession(state.selectedFile));
        ui.endSessionBtn.addEventListener('click', api.endSession);
        ui.goToDemandBtn.addEventListener('click', () => render.switchPage('page-demanda'));

        ui.demandSearchInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            const filteredProducts = state.sessionProducts.filter(p => p.codigo && p.codigo.toLowerCase().includes(query));
            render.demandaTable(filteredProducts);
        });

        // --- INICIALIZAÇÃO ---
        checkActiveSession();
    });
    </script>
</body>
</html>
